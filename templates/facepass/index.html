{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Левая колонка -->
        <div class="col-md-3">
            <!-- База учеников -->
            <div class="card">
                <div class="card-header">
                    <h5>База учеников</h5>
                    <input type="text" class="form-control mt-2" placeholder="Поиск по ФИО..." id="student-search">
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Класс</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="visitor-row">
                                    <td>ФИО ученика</td>
                                    <td>Класс</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Статистика посещений -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Статистика посещений</h5>
                </div>
                <div class="card-body">
                    <canvas id="visitChart" height="200"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Центральная колонка -->
        <div class="col-md-6">
            <h3 class="text-center mb-4">Система учёта посещений</h3>
            
            <!-- Основная камера -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Основная камера</span>
                    <select class="form-select form-select-sm" style="width: auto;" id="main-camera-select">
                        <option value="">Выберите камеру</option>
                        {% for camera in cameras %}
                        <option value="{{ camera.id }}">{{ camera.name }} ({{ camera.get_camera_type_display }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="card-body">
                    <div class="text-center">
                        <div id="camera-feed-container">
                            <img src="http://localhost:8000/static/image/size.png" class="img-fluid rounded" id="main-camera-feed">
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-primary" id="start-training">Обучить модель</button>
                            <button class="btn btn-primary" id="start-recognition">Запустить распознавание</button>
                            <button class="btn btn-outline-secondary" id="stop-recognition" disabled>Остановить</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Журнал посещений -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5>Журнал посещений</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ФИО</th>
                                    <th>Время</th>
                                    <th>Класс</th>
                                    <th>Камера</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>ФИО ученика</td>
                                    <td>Время посещения</td>
                                    <td>Класс</td>
                                    <td>Камера</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3">
                        <button class="btn btn-success">Экспорт в Excel</button>
                        <button class="btn btn-outline-primary float-end">Показать все</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Правая колонка - управление камерами -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5>Подключенные камеры</h5>
                </div>
                <div class="card-body p-0">
                    <ul class="nav nav-tabs" id="cameraTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="added-tab" data-bs-toggle="tab" data-bs-target="#added-cameras" type="button">Добавленные</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="discover-tab" data-bs-toggle="tab" data-bs-target="#discover-cameras" type="button">Добавить новую</button>
                        </li>
                    </ul>
                    <div class="tab-content p-3" id="cameraTabsContent">
                        <!-- Вкладка с добавленными камерами -->
                        <div class="tab-pane fade show active" id="added-cameras" role="tabpanel">
                            <!-- Содержимое будет загружено через JS -->
                        </div>
                        <!-- Вкладка для добавления новых камер -->
                        <div class="tab-pane fade" id="discover-cameras" role="tabpanel">
                            <div class="mb-3">
                                <h6>Доступные USB камеры</h6>
                                    <button class="btn btn-sm btn-outline-secondary" id="refresh-usb-cameras">
                                        <i class="bi bi-arrow-clockwise"></i> Обновить
                                    </button>
                                <div id="usb-cameras-list" class="mt-2">
                                    <!-- Список будет заполнен через JavaScript -->
                                </div>
                            </div>
                            
                            <hr>
                            
                            <div>
                                <h6>Добавить сетевую камеру</h6>
                                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNetworkCameraModal">
                                    Добавить сетевую камеру
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления USB камеры -->
<div class="modal fade" id="addUsbCameraModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить USB камеру</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addUsbCameraForm">
                    <input type="hidden" id="usb-camera-index">
                    <div class="mb-3">
                        <label for="usb-camera-name" class="form-label">Название камеры</label>
                        <input type="text" class="form-control" id="usb-camera-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="usb-camera-location" class="form-label">Расположение</label>
                        <input type="text" class="form-control" id="usb-camera-location" placeholder="Например: Вход в школу">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="save-usb-camera">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для добавления сетевой камеры -->
<div class="modal fade" id="addNetworkCameraModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить сетевую камеру</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addNetworkCameraForm">
                    <div class="mb-3">
                        <label for="network-camera-name" class="form-label">Название камеры</label>
                        <input type="text" class="form-control" id="network-camera-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="network-camera-url" class="form-label">URL камеры</label>
                        <input type="text" class="form-control" id="network-camera-url" placeholder="rtsp:// или http://" required>
                    </div>
                    <div class="mb-3">
                        <label for="network-camera-location" class="form-label">Расположение</label>
                        <input type="text" class="form-control" id="network-camera-location" placeholder="Например: Вход в школу">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="save-network-camera">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для обучения -->
<div class="modal fade" id="trainingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Обучение модели</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="training-progress">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 0%"></div>
                    </div>
                    <div class="text-center mt-2" id="training-status">Подготовка к обучению...</div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.getElementById('start-training').addEventListener('click', startTraining);
    document.getElementById('start-recognition').addEventListener('click', startRecognition);
    document.getElementById('stop-recognition').addEventListener('click', stopRecognition);
// Функция для получения CSRF токена
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function startTraining() {
    const modal = new bootstrap.Modal(document.getElementById('trainingModal'));
    modal.show();
    
    const progressBar = document.querySelector('#training-progress .progress-bar');
    const statusText = document.getElementById('training-status');
    
    fetch('/aimodule/api/train/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            progressBar.style.width = '100%';
            progressBar.classList.remove('progress-bar-animated');
            statusText.innerHTML = `Обучение завершено! Классы: ${data.classes.join(', ')}`;
        } else {
            throw new Error(data.message || 'Ошибка обучения');
        }
    })
    .catch(error => {
        progressBar.classList.add('bg-danger');
        statusText.innerHTML = `Ошибка: ${error.message}`;
    });
}

function startRecognition() {
    fetch('/aimodule/api/toggle-detection/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({action: 'start'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            document.getElementById('start-recognition').disabled = true;
            document.getElementById('stop-recognition').disabled = false;
            showToast('Успех', 'Распознавание запущено', 'success');
        }
    });
}

function stopRecognition() {
    fetch('/aimodule/api/toggle-detection/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({action: 'stop'})
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'stopped') {
            document.getElementById('start-recognition').disabled = false;
            document.getElementById('stop-recognition').disabled = true;
            showToast('Успех', 'Распознавание остановлено', 'success');
        }
    });
}


// Функция для показа уведомлений
function showToast(title, message, type = 'info') {
    const toastContainer = document.getElementById('toast-container') || createToastContainer();
    const toastId = 'toast-' + Date.now();
    
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.id = toastId;
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                <strong>${title}</strong><br>${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    // Удаляем toast после скрытия
    toast.addEventListener('hidden.bs.toast', function() {
        toast.remove();
    });
}

function createToastContainer() {
    const container = document.createElement('div');
    container.id = 'toast-container';
    container.className = 'position-fixed bottom-0 end-0 p-3';
    container.style.zIndex = '11';
    document.body.appendChild(container);
    return container;
}

// Функция для загрузки списка USB камер
function loadUSBCameras() {
    const usbCamerasList = document.getElementById('usb-cameras-list');
    usbCamerasList.innerHTML = `
        <div class="text-center py-3">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p>Поиск доступных USB камер...</p>
        </div>
    `;
    
    fetch('/facepass/api/usb-cameras/')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log("Received data:", data); // Добавьте это для отладки
            if (data.success) {
                if (data.cameras && data.cameras.length > 0) {
                    displayCamerasList(data.cameras);
                } else {
                    usbCamerasList.innerHTML = `
                        <div class="alert alert-warning mt-3">
                            USB камеры не обнаружены. Подключите камеру и нажмите "Обновить".
                        </div>
                    `;
                }
            } else {
                throw new Error(data.message || "Unknown error");
            }
        })
        .catch(error => {
            console.error("Error loading USB cameras:", error); // Добавьте это для отладки
            usbCamerasList.innerHTML = `
                <div class="alert alert-danger mt-3">
                    Ошибка: ${error.message}
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadUSBCameras()">
                        Попробовать снова
                    </button>
                </div>
            `;
        });
}

// Функция для отображения списка камер
function displayCamerasList(cameras) {
    const usbCamerasList = document.getElementById('usb-cameras-list');
    usbCamerasList.innerHTML = '';
    
    if (cameras.length === 0) {
        usbCamerasList.innerHTML = '<div class="alert alert-info">Камеры не найдены</div>';
        return;
    }
    
    const listGroup = document.createElement('div');
    listGroup.className = 'list-group';
    
    cameras.forEach(camera => {
        const item = document.createElement('div');
        item.className = 'list-group-item d-flex justify-content-between align-items-center';
        item.innerHTML = `
            <div>
                <strong>${camera.name}</strong>
                <div class="text-muted small">Разрешение: ${camera.resolution}</div>
            </div>
            <button class="btn btn-sm btn-outline-primary add-usb-camera-btn" 
                    data-index="${camera.index}" 
                    data-name="${camera.name}">
                Добавить
            </button>
        `;
        listGroup.appendChild(item);
    });
    
    usbCamerasList.appendChild(listGroup);
    
    // Добавляем обработчики для кнопок "Добавить"
    document.querySelectorAll('.add-usb-camera-btn').forEach(button => {
        button.addEventListener('click', function() {
            const index = this.getAttribute('data-index');
            const name = this.getAttribute('data-name');
            openAddUsbCameraModal(index, name);
        });
    });
}

// Функция для открытия модального окна добавления USB камеры
function openAddUsbCameraModal(index, name) {
    document.getElementById('usb-camera-index').value = index;
    document.getElementById('usb-camera-name').value = name || `USB Camera ${index}`;
    
    const modal = new bootstrap.Modal(document.getElementById('addUsbCameraModal'));
    modal.show();
}

// Функция для сохранения USB камеры
function saveUSBCamera() {
    const cameraData = {
        name: document.getElementById('usb-camera-name').value,
        camera_type: 'usb',
        source: document.getElementById('usb-camera-index').value,
        location: document.getElementById('usb-camera-location').value || null
    };

    const saveButton = document.getElementById('save-usb-camera');
    const originalText = saveButton.innerHTML;
    saveButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Сохранение...';
    saveButton.disabled = true;

    fetch('/facepass/api/cameras/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify(cameraData)
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(err => { throw err; });
        }
        return response.json();
    })
    .then(data => {
        const modal = bootstrap.Modal.getInstance(document.getElementById('addUsbCameraModal'));
        modal.hide();
        showToast('Успех', `Камера "${data.name}" добавлена`, 'success');
        loadAddedCameras();
    })
    .catch(error => {
        const errorMsg = error.message || error.detail || 'Ошибка при сохранении';
        showToast('Ошибка', errorMsg, 'danger');
    })
    .finally(() => {
        saveButton.innerHTML = originalText;
        saveButton.disabled = false;
    });
}


// Функция для загрузки добавленных камер
function loadAddedCameras() {
    const container = document.querySelector('#added-cameras');
    container.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';

    fetch('/facepass/api/cameras/')
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.length > 0) {
            container.innerHTML = `
                <div class="list-group">
                    ${data.map(camera => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${camera.name}</strong>
                                    <div class="text-muted small">
                                        ${camera.camera_type_display} | ${camera.location || 'Расположение не указано'}
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger remove-camera-btn" data-id="${camera.id}">
                                        Удалить
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            // Добавляем обработчики для кнопок удаления
            document.querySelectorAll('.remove-camera-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const cameraId = this.getAttribute('data-id');
                    removeCamera(cameraId);
                });
            });
        } else {
            container.innerHTML = '<div class="alert alert-info">Нет добавленных камер</div>';
        }
    })
    .catch(error => {
        container.innerHTML = `
            <div class="alert alert-danger">
                Ошибка загрузки: ${error.message}
                <button class="btn btn-sm btn-outline-secondary mt-2" onclick="loadAddedCameras()">
                    Попробовать снова
                </button>
            </div>
        `;
    });
}

// Функция для удаления камеры
function removeCamera(cameraId) {
    if (!confirm('Вы уверены, что хотите удалить эту камеру?')) return;

    showToast('Информация', 'Удаление камеры...', 'info');
    
    fetch(`/facepass/api/cameras/${cameraId}/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Ошибка при удалении');
        }
        return response.json();
    })
    .then(data => {
        showToast('Успех', data.message || 'Камера удалена', 'success');
        loadAddedCameras();
    })
    .catch(error => {
        showToast('Ошибка', error.message, 'danger');
    });
}
// Функция для обновления видеопотока
function updateCameraFeed(cameraId) {
    const cameraFeed = document.getElementById('main-camera-feed');
    const feedContainer = document.getElementById('camera-feed-container');
    
    if (!cameraId) {
        cameraFeed.src = "http://localhost:8000/static/image/size.png";
        return;
    }
    
    // Показываем индикатор загрузки
    feedContainer.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
            <p>Подключение к камере...</p>
        </div>
    `;
    
    // Устанавливаем новый источник видео
    const streamUrl = `/facepass/camera_stream/${cameraId}/`;
    const imgElement = document.createElement('img');
    imgElement.id = 'main-camera-feed';
    imgElement.className = 'img-fluid rounded';
    imgElement.src = streamUrl;
    
    imgElement.onload = function() {
        feedContainer.innerHTML = '';
        feedContainer.appendChild(imgElement);
    };
    
    imgElement.onerror = function() {
        feedContainer.innerHTML = `
            <div class="alert alert-danger">
                Не удалось подключиться к камере
            </div>
        `;
    };
}

// Обработчик изменения выбора камеры
document.getElementById('main-camera-select').addEventListener('change', function() {
    const selectedCameraId = this.value;
    updateCameraFeed(selectedCameraId);
});

// Функция для загрузки списка камер в выпадающий список
function loadCamerasToSelect() {
    const select = document.getElementById('main-camera-select');
    
    fetch('/facepass/api/cameras/')
        .then(response => response.json())
        .then(data => {
            // Очищаем существующие опции, кроме первой
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Добавляем новые опции
            data.forEach(camera => {
                const option = document.createElement('option');
                option.value = camera.id;
                option.text = `${camera.name} (${camera.camera_type_display})`;
                select.add(option);
            });
        })
        .catch(error => {
            console.error('Ошибка загрузки камер:', error);
        });
}

// Инициализация при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    // Загружаем добавленные камеры
    loadAddedCameras();
    
    // Обработчик для кнопки обновления USB камер
    document.getElementById('refresh-usb-cameras').addEventListener('click', loadUSBCameras);
    
    // Обработчик для вкладки "Добавить новую"
    document.getElementById('discover-tab').addEventListener('click', loadUSBCameras);
    
    // Обработчик для сохранения USB камеры
    document.getElementById('save-usb-camera').addEventListener('click', saveUSBCamera);
    
    // Если вкладка "Добавить новую" активна при загрузке
    if (document.getElementById('discover-tab').classList.contains('active')) {
        loadUSBCameras();
    }

    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function() {
            if (this.id === 'discover-tab' || this.id === 'added-tab') {
                loadCamerasToSelect();
            }
        });
    });
});
</script>
{% endblock %}